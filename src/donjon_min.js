document.addEventListener("contextmenu",e=>e.preventDefault()),c=document.getElementById("canvas"),ctx=c.getContext("2d"),img_jouer=new Image,img_jouer.src="graphics/play_bouton.png",img_floor=new Image,img_floor.src="graphics/floor_tile.png",img_wall=new Image,img_wall.src="graphics/wall_tile.png",img_edition=new Image,img_edition.src="graphics/edition.png",img_ajout=new Image,img_ajout.src="graphics/ajout_salle.png",img_interrupteur=new Image,img_interrupteur.src="graphics/interrupteur_tile.png",img_interrupteur_rouge=new Image,img_interrupteur_rouge.src="graphics/red_interrupteur_tile.png",img_interrupteur_bleu=new Image,img_interrupteur_bleu.src="graphics/blue_interrupteur_tile.png",img_interrupteur_vert=new Image,img_interrupteur_vert.src="graphics/green_interrupteur_tile.png",img_interrupteur_jaune=new Image,img_interrupteur_jaune.src="graphics/yellow_interrupteur_tile.png",img_interrupteur_rouge_active=new Image,img_interrupteur_rouge_active.src="graphics/red_interrupteur_tile_active.png",img_interrupteur_bleu_active=new Image,img_interrupteur_bleu_active.src="graphics/blue_interrupteur_tile_active.png",img_interrupteur_vert_active=new Image,img_interrupteur_vert_active.src="graphics/green_interrupteur_tile_active.png",img_interrupteur_jaune_active=new Image,img_interrupteur_jaune_active.src="graphics/yellow_interrupteur_tile_active.png",img_cle=new Image,img_cle.src="graphics/key_tile.png",img_cle_rouge=new Image,img_cle_rouge.src="graphics/red_key_tile.png",img_cle_bleue=new Image,img_cle_bleue.src="graphics/blue_key_tile.png",img_cle_verte=new Image,img_cle_verte.src="graphics/green_key_tile.png",img_cle_jaune=new Image,img_cle_jaune.src="graphics/yellow_key_tile.png",img_door=new Image,img_door.src="graphics/door_tile.png",img_porte_rouge=new Image,img_porte_rouge.src="graphics/red_door.png",img_porte_bleue=new Image,img_porte_bleue.src="graphics/blue_door.png",img_porte_verte=new Image,img_porte_verte.src="graphics/green_door.png",img_porte_jaune=new Image,img_porte_jaune.src="graphics/yellow_door.png",imgs_portes=[img_porte_rouge,img_porte_bleue,img_porte_verte,img_porte_jaune],img_pics_leves=new Image,img_pics_leves.src="graphics/pics_leves_tile.png",img_pics_leves_rouges=new Image,img_pics_leves_rouges.src="graphics/pics_leves_rouges.png",img_pics_leves_bleus=new Image,img_pics_leves_bleus.src="graphics/pics_leves_bleus.png",img_pics_leves_verts=new Image,img_pics_leves_verts.src="graphics/pics_leves_verts.png",img_pics_leves_jaunes=new Image,img_pics_leves_jaunes.src="graphics/pics_leves_jaunes.png",img_pics_baisses_rouges=new Image,img_pics_baisses_rouges.src="graphics/pics_baisses_rouges.png",img_pics_baisses_bleus=new Image,img_pics_baisses_bleus.src="graphics/pics_baisses_bleus.png",img_pics_baisses_verts=new Image,img_pics_baisses_verts.src="graphics/pics_baisses_verts.png",img_pics_baisses_jaunes=new Image,img_pics_baisses_jaunes.src="graphics/pics_baisses_jaunes.png",imgs_pics_leves=[img_pics_leves_rouges,img_pics_leves_bleus,img_pics_leves_verts,img_pics_leves_jaunes],imgs_pics_baisses=[img_pics_baisses_rouges,img_pics_baisses_bleus,img_pics_baisses_verts,img_pics_baisses_jaunes],img_change_mode_cle_interrupteur=new Image,img_change_mode_cle_interrupteur.src="graphics/change_mode_cle_interrupteur.png",img_ajout_cle=new Image,img_ajout_cle.src="graphics/ajout_cle.png",img_export=new Image,img_export.src="graphics/export_bouton.png",img_entree=new Image,img_entree.src="graphics/echelle.png",img_sortie=new Image,img_sortie.src="graphics/tresor.png",img_personnage=new Image,img_personnage.src="graphics/personnage.png",img_tete_personnage=new Image,img_tete_personnage.src="graphics/tete_perso.png",imgs_game=[img_floor,img_wall,img_entree,img_sortie,img_cle_rouge,img_cle_bleue,img_cle_verte,img_cle_jaune,img_floor,img_floor,img_floor,img_porte_rouge,img_porte_bleue,img_porte_verte,img_porte_jaune,img_floor,img_floor,img_floor,img_floor,img_floor,img_floor,img_pics_leves_rouges,img_pics_leves_bleus,img_pics_leves_verts,img_pics_leves_jaunes,img_floor,img_floor,img_floor,img_floor,img_floor,img_floor,img_pics_baisses_rouges,img_pics_baisses_bleus,img_pics_baisses_verts,img_pics_baisses_jaunes],vi={i:-1,j:-1},vf={i:-1,j:-1},xy_actu={x:0,y:0},xy_prec={x:0,y:0},orientationsInterrupteurs=[0,0,0,0],map=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],map_game=[],map_exploree=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]];for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s]={is_salle:!1,haut:"ouvert",bas:"ouvert",droite:"ouvert",gauche:"ouvert",contains_key:0};function compute_xy(e,s){return{x:Math.floor(e/90),y:Math.floor(s/90)}}function getMousePos(e,s){var a=e.getBoundingClientRect();return{x:s.clientX-a.left,y:s.clientY-a.top}}function mouseMove(e){var s=getMousePos(c,e);xPos=s.x,yPos=s.y}xPos=0,yPos=0,i_clic=0,j_clic=0,donjon_importe="",time_start=-1,time_victory=-1,c.addEventListener("mousemove",function(e){mouseMove(e)},!1),c.addEventListener("mousedown",function(e){if(e.preventDefault(),xPos>900&&xPos<990&&yPos>0&&yPos<360)mode=Math.floor(yPos/90);else if(xPos>900&&xPos<990&&yPos>360&&yPos<450){for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s].is_salle&&0==mode_cle?("pics_leves"===map[e][s].haut.substr(0,10)?map[e][s].haut="door"+map[e][s].haut.substr(10,1):"pics_baiss"===map[e][s].haut.substr(0,10)&&(map[e][s].haut="ouvert"),"pics_leves"===map[e][s].droite.substr(0,10)?map[e][s].droite="door"+map[e][s].droite.substr(10,1):"pics_baiss"===map[e][s].droite.substr(0,10)&&(map[e][s].droite="ouvert"),"pics_leves"===map[e][s].bas.substr(0,10)?map[e][s].bas="door"+map[e][s].bas.substr(10,1):"pics_baiss"===map[e][s].bas.substr(0,10)&&(map[e][s].bas="ouvert"),"pics_leves"===map[e][s].gauche.substr(0,10)?map[e][s].gauche="door"+map[e][s].gauche.substr(10,1):"pics_baiss"===map[e][s].gauche.substr(0,10)&&(map[e][s].gauche="ouvert")):map[e][s].is_salle&&1==mode_cle&&("door"===map[e][s].haut.substr(0,4)&&(map[e][s].haut="pics_leves"+map[e][s].haut.substr(4,1)),"door"===map[e][s].droite.substr(0,4)&&(map[e][s].droite="pics_leves"+map[e][s].droite.substr(4,1)),"door"===map[e][s].bas.substr(0,4)&&(map[e][s].bas="pics_leves"+map[e][s].bas.substr(4,1)),"door"===map[e][s].gauche.substr(0,4)&&(map[e][s].gauche="pics_leves"+map[e][s].gauche.substr(4,1)));mode_cle=1-mode_cle}else xPos>900&&xPos<990&&yPos>450&&yPos<540?export_donjon_reimportable():xPos>900&&xPos<990&&yPos>540&&yPos<630?(goToGame(),continue_edition=0):xPos<900&&(j_clic=Math.min(Math.max(Math.floor(xPos/90),0),9),i_clic=Math.min(Math.max(Math.floor(yPos/90),0),7),0==mode&&map[i_clic][j_clic].is_salle?(xPos%90>=36&&xPos%90<=54?yPos%90>=0&&yPos%90<=18?i_clic>0&&map[i_clic-1][j_clic].is_salle&&("ferme"!==map[i_clic-1][j_clic].bas?(map[i_clic-1][j_clic].bas="ferme",map[i_clic][j_clic].haut="ferme"):"ouvert"!==map[i_clic-1][j_clic].bas&&(map[i_clic-1][j_clic].bas="ouvert",map[i_clic][j_clic].haut="ouvert")):yPos%90>=72&&yPos%90<=90&&i_clic<7&&map[i_clic+1][j_clic].is_salle&&("ferme"!==map[i_clic+1][j_clic].haut?(map[i_clic+1][j_clic].haut="ferme",map[i_clic][j_clic].bas="ferme"):"ouvert"!==map[i_clic+1][j_clic].haut&&(map[i_clic+1][j_clic].haut="ouvert",map[i_clic][j_clic].bas="ouvert")):yPos%90>=36&&yPos%90<=54&&(xPos%90>=0&&xPos%90<=18?j_clic>0&&map[i_clic][j_clic-1].is_salle&&("ferme"!==map[i_clic][j_clic-1].droite?(map[i_clic][j_clic-1].droite="ferme",map[i_clic][j_clic].gauche="ferme"):"ouvert"!==map[i_clic][j_clic-1].droite&&(map[i_clic][j_clic-1].droite="ouvert",map[i_clic][j_clic].gauche="ouvert")):xPos%90>=72&&xPos%90<=90&&j_clic<9&&map[i_clic][j_clic+1].is_salle&&("ferme"!==map[i_clic][j_clic+1].gauche?(map[i_clic][j_clic+1].gauche="ferme",map[i_clic][j_clic].droite="ferme"):"ouvert"!==map[i_clic][j_clic+1].gauche&&(map[i_clic][j_clic+1].gauche="ouvert",map[i_clic][j_clic].droite="ouvert"))),yPos%90>18&&yPos%90<72&&xPos%90>18&&xPos%90<72&&(1==e.which?(vi.i=i_clic,vi.j=j_clic):3==e.which&&(vf.i=i_clic,vf.j=j_clic))):1==mode?1==e.which?ajout_salle(i_clic,j_clic):3==e.which&&retrait_salle(i_clic,j_clic):2==mode?1==e.which&&map[i_clic][j_clic].is_salle?ajout_cle(i_clic,j_clic):3==e.which&&map[i_clic][j_clic].is_salle&&retrait_cle(i_clic,j_clic):3==mode&&1==mode_cle&&map[i_clic][j_clic].is_salle?xPos%90>=36&&xPos%90<=54?yPos%90>=0&&yPos%90<=18?i_clic>0&&map[i_clic-1][j_clic].is_salle&&(1==e.which?"door"!==map[i_clic-1][j_clic].bas.substr(0,4)?(map[i_clic-1][j_clic].bas="door1",map[i_clic][j_clic].haut="door1"):(door_nb=parseInt(map[i_clic-1][j_clic].bas.substr(4,1)),map[i_clic-1][j_clic].bas="door"+(1+door_nb%4),map[i_clic][j_clic].haut="door"+(1+door_nb%4)):3==e.which&&(map[i_clic-1][j_clic].bas="ouvert",map[i_clic][j_clic].haut="ouvert")):yPos%90>=72&&yPos%90<=90&&i_clic<7&&map[i_clic+1][j_clic].is_salle&&(1==e.which?"door"!==map[i_clic+1][j_clic].haut.substr(0,4)?(map[i_clic+1][j_clic].haut="door1",map[i_clic][j_clic].bas="door1"):(door_nb=parseInt(map[i_clic+1][j_clic].haut.substr(4,1)),map[i_clic+1][j_clic].haut="door"+(1+door_nb%4),map[i_clic][j_clic].bas="door"+(1+door_nb%4)):3==e.which&&(map[i_clic+1][j_clic].haut="ouvert",map[i_clic][j_clic].bas="ouvert")):yPos%90>=36&&yPos%90<=54&&(xPos%90>=0&&xPos%90<=18?j_clic>0&&map[i_clic][j_clic-1].is_salle&&(1==e.which?"door"!==map[i_clic][j_clic-1].droite.substr(0,4)?(map[i_clic][j_clic-1].droite="door1",map[i_clic][j_clic].gauche="door1"):(door_nb=parseInt(map[i_clic][j_clic-1].droite.substr(4,1)),map[i_clic][j_clic-1].droite="door"+(1+door_nb%4),map[i_clic][j_clic].gauche="door"+(1+door_nb%4)):3==e.which&&(map[i_clic][j_clic-1].droite="ouvert",map[i_clic][j_clic].gauche="ouvert")):xPos%90>=72&&xPos%90<=90&&j_clic<9&&map[i_clic][j_clic+1].is_salle&&(1==e.which?"door"!==map[i_clic][j_clic+1].gauche.substr(0,4)?(map[i_clic][j_clic+1].gauche="door1",map[i_clic][j_clic].droite="door1"):(door_nb=parseInt(map[i_clic][j_clic+1].gauche.substr(4,1)),map[i_clic][j_clic+1].gauche="door"+(1+door_nb%4),map[i_clic][j_clic].droite="door"+(1+door_nb%4)):3==e.which&&(map[i_clic][j_clic+1].gauche="ouvert",map[i_clic][j_clic].droite="ouvert"))):3==mode&&0==mode_cle&&map[i_clic][j_clic].is_salle&&(xPos%90>=36&&xPos%90<=54?yPos%90>=0&&yPos%90<=18?i_clic>0&&map[i_clic-1][j_clic].is_salle&&(1==e.which?"pics"!==map[i_clic-1][j_clic].bas.substr(0,4)?(map[i_clic-1][j_clic].bas="pics_leves1",map[i_clic][j_clic].haut="pics_leves1"):(door_nb=parseInt(map[i_clic-1][j_clic].bas.substr(10,1)),"leves"===map[i_clic-1][j_clic].bas.substr(5,5)?(map[i_clic-1][j_clic].bas="pics_baiss"+door_nb,map[i_clic][j_clic].haut="pics_baiss"+door_nb):"baiss"===map[i_clic-1][j_clic].bas.substr(5,5)&&(map[i_clic-1][j_clic].bas="pics_leves"+(1+door_nb%4),map[i_clic][j_clic].haut="pics_leves"+(1+door_nb%4))):3==e.which&&(map[i_clic-1][j_clic].bas="ouvert",map[i_clic][j_clic].haut="ouvert")):yPos%90>=72&&yPos%90<=90&&i_clic<7&&map[i_clic+1][j_clic].is_salle&&(1==e.which?"pics"!==map[i_clic+1][j_clic].haut.substr(0,4)?(map[i_clic+1][j_clic].haut="pics_leves1",map[i_clic][j_clic].bas="pics_leves1"):(door_nb=parseInt(map[i_clic+1][j_clic].haut.substr(10,1)),"leves"===map[i_clic+1][j_clic].haut.substr(5,5)?(map[i_clic+1][j_clic].haut="pics_baiss"+door_nb,map[i_clic][j_clic].bas="pics_baiss"+door_nb):"baiss"===map[i_clic+1][j_clic].haut.substr(5,5)&&(map[i_clic+1][j_clic].haut="pics_leves"+(1+door_nb%4),map[i_clic][j_clic].bas="pics_leves"+(1+door_nb%4))):3==e.which&&(map[i_clic+1][j_clic].haut="ouvert",map[i_clic][j_clic].bas="ouvert")):yPos%90>=36&&yPos%90<=54&&(xPos%90>=0&&xPos%90<=18?j_clic>0&&map[i_clic][j_clic-1].is_salle&&(1==e.which?"pics"!==map[i_clic][j_clic-1].droite.substr(0,4)?(map[i_clic][j_clic-1].droite="pics_leves1",map[i_clic][j_clic].gauche="pics_leves1"):(door_nb=parseInt(map[i_clic][j_clic-1].droite.substr(10,1)),"leves"===map[i_clic][j_clic-1].droite.substr(5,5)?(map[i_clic][j_clic-1].droite="pics_baiss"+door_nb,map[i_clic][j_clic].gauche="pics_baiss"+door_nb):"baiss"===map[i_clic][j_clic-1].droite.substr(5,5)&&(map[i_clic][j_clic-1].droite="pics_leves"+(1+door_nb%4),map[i_clic][j_clic].gauche="pics_leves"+(1+door_nb%4))):3==e.which&&(map[i_clic][j_clic-1].droite="ouvert",map[i_clic][j_clic].gauche="ouvert")):xPos%90>=72&&xPos%90<=90&&j_clic<9&&map[i_clic][j_clic+1].is_salle&&(1==e.which?"pics"!==map[i_clic][j_clic+1].gauche.substr(0,4)?(map[i_clic][j_clic+1].gauche="pics_leves1",map[i_clic][j_clic].droite="pics_leves1"):(door_nb=parseInt(map[i_clic][j_clic+1].gauche.substr(10,1)),"leves"===map[i_clic][j_clic+1].gauche.substr(5,5)?(map[i_clic][j_clic+1].gauche="pics_baiss"+door_nb,map[i_clic][j_clic].droite="pics_baiss"+door_nb):"baiss"===map[i_clic][j_clic+1].gauche.substr(5,5)&&(map[i_clic][j_clic+1].gauche="pics_leves"+(1+door_nb%4),map[i_clic][j_clic].droite="pics_leves"+(1+door_nb%4))):3==e.which&&(map[i_clic][j_clic+1].gauche="ouvert",map[i_clic][j_clic].droite="ouvert")))))},!1);var donjonImporter=document.getElementById("donjonImport");function handleAnnotationsSelect(e){var s=e.target.files;if(0!==s.length){var a=s[0];if(""===a.type||a.type.match("application.json")){var i=new FileReader;i.onload=function(e){donjon_importe=e.srcElement.result,import_donjon(donjon_importe)},i.readAsText(a)}}}function animate(){continue_edition?requestAnimationFrame(animate):requestAnimationFrame(animateGame),ctx.clearRect(0,0,1200,720),ctx.drawImage(img_edition,900,0),ctx.drawImage(img_ajout,900,90),1==mode_cle?(ctx.drawImage(img_ajout_cle,900,180),ctx.drawImage(img_door,900,270)):(ctx.drawImage(img_interrupteur,900,180),ctx.drawImage(img_pics_leves,900,270)),ctx.drawImage(img_change_mode_cle_interrupteur,900,360),ctx.drawImage(img_export,900,450),ctx.drawImage(img_jouer,900,540),ctx.globalAlpha=.4,ctx.beginPath(),ctx.moveTo(900,90*mode),ctx.lineTo(990,90*mode),ctx.lineTo(990,90*(mode+1)),ctx.lineTo(900,90*(mode+1)),ctx.lineTo(900,90*mode),ctx.fillStyle="#ff0000",ctx.fill(),ctx.globalAlpha=1,ctx.globalAlpha=.7,xPos>900&&xPos<990&&yPos>0&&yPos<540&&(ctx.fillStyle="#000080",ctx.beginPath(),ctx.moveTo(xPos-200,yPos-30),ctx.lineTo(xPos+210,yPos-30),ctx.lineTo(xPos+210,yPos+30),ctx.lineTo(xPos-200,yPos+30),ctx.lineTo(xPos-200,yPos-30),ctx.stroke(),ctx.fill(),ctx.fillStyle="#ffffff",ctx.globalAlpha=1,yPos>0&&yPos<90?(ctx.strokeText("Edition :",xPos-190,yPos-17),ctx.fillText("Edition :",xPos-190,yPos-17),ctx.strokeText("Clic gauche dans une salle pour placer l'entree",xPos-190,yPos-3),ctx.fillText("Clic gauche dans une salle pour placer l'entree",xPos-190,yPos-3),ctx.strokeText("Clic droit dans une salle pour placer la sortie",xPos-190,yPos+11),ctx.fillText("Clic droit dans une salle pour placer la sortie",xPos-190,yPos+11),ctx.strokeText("Clic sur un couloir pour ajouter/retirer un mur",xPos-190,yPos+25),ctx.fillText("Clic sur un couloir pour ajouter/retirer un mur",xPos-190,yPos+25)):yPos>90&&yPos<180?(ctx.strokeText("Agencement des salles :",xPos-190,yPos-17),ctx.fillText("Agencement des salles :",xPos-190,yPos-17),ctx.strokeText("Clic gauche pour placer une salle",xPos-190,yPos-3),ctx.fillText("Clic gauche pour placer une salle",xPos-190,yPos-3),ctx.strokeText("Clic droit pour retirer une salle",xPos-190,yPos+11),ctx.fillText("Clic droit pour retirer une salle",xPos-190,yPos+11)):yPos>180&&yPos<270?1==mode_cle?(ctx.strokeText("Mode placement des cles :",xPos-190,yPos-17),ctx.fillText("Mode placement des cles :",xPos-190,yPos-17),ctx.strokeText("Clic gauche pour placer une cle",xPos-190,yPos-3),ctx.fillText("Clic gauche pour placer une cle",xPos-190,yPos-3),ctx.strokeText("Clic droit pour retirer une cle",xPos-190,yPos+11),ctx.fillText("Clic droit pour retirer une cle",xPos-190,yPos+11),ctx.strokeText("Cliquez plusieurs fois pour changer la couleur d'une cle",xPos-190,yPos+25),ctx.fillText("Cliquez plusieurs fois pour changer la couleur d'une cle",xPos-190,yPos+25)):(ctx.strokeText("Mode placement des interrupteurs :",xPos-190,yPos-17),ctx.fillText("Mode placement des interrupteurs :",xPos-190,yPos-17),ctx.strokeText("Clic gauche pour placer un interrupteur",xPos-190,yPos-3),ctx.fillText("Clic gauche pour placer un interrupteur",xPos-190,yPos-3),ctx.strokeText("Clic droit pour retirer un interrupteur",xPos-190,yPos+11),ctx.fillText("Clic droit pour retirer un interrupteur",xPos-190,yPos+11),ctx.strokeText("Cliquez plusieurs fois pour changer la couleur d'un interrupteur",xPos-190,yPos+25),ctx.fillText("Cliquez plusieurs fois pour changer la couleur d'un interrupteur",xPos-190,yPos+25)):yPos>270&&yPos<360?1==mode_cle?(ctx.strokeText("Mode placement des portes :",xPos-190,yPos-17),ctx.fillText("Mode placement des portes :",xPos-190,yPos-17),ctx.strokeText("Clic gauche sur un couloir pour placer une porte",xPos-190,yPos-3),ctx.fillText("Clic gauche sur un couloir pour placer une porte",xPos-190,yPos-3),ctx.strokeText("Clic droit sur un couloir pour retirer une porte",xPos-190,yPos+11),ctx.fillText("Clic droit sur un couloir pour retirer une porte",xPos-190,yPos+11),ctx.strokeText("Cliquez plusieurs fois pour changer la couleur d'une porte",xPos-190,yPos+25),ctx.fillText("Cliquez plusieurs fois pour changer la couleur d'une porte",xPos-190,yPos+25)):(ctx.strokeText("Mode placement des pics :",xPos-190,yPos-17),ctx.fillText("Mode placement des pics :",xPos-190,yPos-17),ctx.strokeText("Clic gauche pour placer des pics",xPos-190,yPos-3),ctx.fillText("Clic gauche pour placer des pics",xPos-190,yPos-3),ctx.strokeText("Clic droit pour retirer des pics",xPos-190,yPos+11),ctx.fillText("Clic droit pour retirer des pics",xPos-190,yPos+11),ctx.strokeText("Cliquez plusieurs fois pour changer la couleur des pics et alterner entre leves/baisses",xPos-190,yPos+25),ctx.fillText("Cliquez plusieurs fois pour changer la couleur des pics et alterner entre leves/baisses",xPos-190,yPos+25)):yPos>360&&yPos<450?(ctx.strokeText("Changement de mode clés et portes / interrupteurs et pics",xPos-190,yPos-17),ctx.fillText("Changement de mode clés et portes / interrupteurs et pics",xPos-190,yPos-17),ctx.strokeText("Permet de passer du mode clés au mode interrupteurs",xPos-190,yPos-3),ctx.fillText("Permet de passer du mode clés au mode interrupteurs",xPos-190,yPos-3)):yPos>450&&yPos<540&&(ctx.strokeText("Exporter le fichier au format Caml",xPos-190,yPos-17),ctx.fillText("Exporter le fichier au format Caml",xPos-190,yPos-17))),ctx.globalAlpha=1;for(let e=0;e<8;e++)for(let s=0;s<10;s++)if(salle=map[e][s],salle.is_salle){for(let a=0;a<5;a++)for(let i=0;i<5;i++)ctx.drawImage(img_floor,90*s+18*i,90*e+18*a,18,18);vi.i==e&&vi.j==s&&ctx.drawImage(img_entree,90*s+18,90*e+18,54,54),vf.i==e&&vf.j==s&&ctx.drawImage(img_sortie,90*s+18,90*e+18,54,54),ctx.drawImage(img_wall,90*s+0,90*e+0,18,18),ctx.drawImage(img_wall,90*s+18,90*e+0,18,18),ctx.drawImage(img_wall,90*s+54,90*e+0,18,18),ctx.drawImage(img_wall,90*s+72,90*e+0,18,18),ctx.drawImage(img_wall,90*s+0,90*e+72,18,18),ctx.drawImage(img_wall,90*s+18,90*e+72,18,18),ctx.drawImage(img_wall,90*s+54,90*e+72,18,18),ctx.drawImage(img_wall,90*s+72,90*e+72,18,18),ctx.drawImage(img_wall,90*s+0,90*e+18,18,18),ctx.drawImage(img_wall,90*s+0,90*e+54,18,18),ctx.drawImage(img_wall,90*s+72,90*e+18,18,18),ctx.drawImage(img_wall,90*s+72,90*e+54,18,18),1==salle.contains_key?1==mode_cle?ctx.drawImage(img_cle_rouge,90*s+18,90*e+18,54,54):ctx.drawImage(img_interrupteur_rouge,90*s+18,90*e+18,54,54):2==salle.contains_key?1==mode_cle?ctx.drawImage(img_cle_bleue,90*s+18,90*e+18,54,54):ctx.drawImage(img_interrupteur_bleu,90*s+18,90*e+18,54,54):3==salle.contains_key?1==mode_cle?ctx.drawImage(img_cle_verte,90*s+18,90*e+18,54,54):ctx.drawImage(img_interrupteur_vert,90*s+18,90*e+18,54,54):4==salle.contains_key&&(1==mode_cle?ctx.drawImage(img_cle_jaune,90*s+18,90*e+18,54,54):ctx.drawImage(img_interrupteur_jaune,90*s+18,90*e+18,54,54)),ouvert_haut="ouvert"===salle.haut&&e>0&&map[e-1][s].is_salle&&"ouvert"===map[e-1][s].bas,ouvert_haut||ctx.drawImage(img_wall,90*s+36,90*e+0,18,18),ouvert_bas="ouvert"===salle.bas&&e<7&&map[e+1][s].is_salle&&"ouvert"===map[e+1][s].haut,ouvert_bas||ctx.drawImage(img_wall,90*s+36,90*e+72,18,18),ouvert_gauche="ouvert"===salle.gauche&&s>0&&map[e][s-1].is_salle&&"ouvert"===map[e][s-1].droite,ouvert_gauche||ctx.drawImage(img_wall,90*s+0,90*e+36,18,18),ouvert_droite="ouvert"===salle.droite&&s<9&&map[e][s+1].is_salle&&"ouvert"===map[e][s+1].gauche,ouvert_droite||ctx.drawImage(img_wall,90*s+72,90*e+36,18,18),"door"===salle.haut.substr(0,4)&&map[e-1][s].is_salle&&map[e-1][s].bas===salle.haut&&ctx.drawImage(imgs_portes[parseInt(salle.haut.substr(4,1))-1],90*s+36,90*e+0,18,18),"door"===salle.bas.substr(0,4)&&map[e+1][s].is_salle&&map[e+1][s].haut===salle.bas&&ctx.drawImage(imgs_portes[parseInt(salle.bas.substr(4,1))-1],90*s+36,90*e+72,18,18),"door"===salle.droite.substr(0,4)&&map[e][s+1].is_salle&&map[e][s+1].gauche===salle.droite&&ctx.drawImage(imgs_portes[parseInt(salle.droite.substr(4,1))-1],90*s+72,90*e+36,18,18),"door"===salle.gauche.substr(0,4)&&map[e][s-1].is_salle&&map[e][s-1].droite===salle.gauche&&ctx.drawImage(imgs_portes[parseInt(salle.gauche.substr(4,1))-1],90*s+0,90*e+36,18,18),"pics_leves"===salle.haut.substr(0,10)&&map[e-1][s].is_salle&&map[e-1][s].bas===salle.haut&&ctx.drawImage(imgs_pics_leves[parseInt(salle.haut.substr(10,1))-1],90*s+36,90*e+0,18,18),"pics_leves"===salle.bas.substr(0,10)&&map[e+1][s].is_salle&&map[e+1][s].haut===salle.bas&&ctx.drawImage(imgs_pics_leves[parseInt(salle.bas.substr(10,1))-1],90*s+36,90*e+72,18,18),"pics_leves"===salle.droite.substr(0,10)&&map[e][s+1].is_salle&&map[e][s+1].gauche===salle.droite&&ctx.drawImage(imgs_pics_leves[parseInt(salle.droite.substr(10,1))-1],90*s+72,90*e+36,18,18),"pics_leves"===salle.gauche.substr(0,10)&&map[e][s-1].is_salle&&map[e][s-1].droite===salle.gauche&&ctx.drawImage(imgs_pics_leves[parseInt(salle.gauche.substr(10,1))-1],90*s+0,90*e+36,18,18),"pics_baiss"===salle.haut.substr(0,10)&&map[e-1][s].is_salle&&map[e-1][s].bas===salle.haut&&ctx.drawImage(imgs_pics_baisses[parseInt(salle.haut.substr(10,1))-1],90*s+36,90*e+0,18,18),"pics_baiss"===salle.bas.substr(0,10)&&map[e+1][s].is_salle&&map[e+1][s].haut===salle.bas&&ctx.drawImage(imgs_pics_baisses[parseInt(salle.bas.substr(10,1))-1],90*s+36,90*e+72,18,18),"pics_baiss"===salle.droite.substr(0,10)&&map[e][s+1].is_salle&&map[e][s+1].gauche===salle.droite&&ctx.drawImage(imgs_pics_baisses[parseInt(salle.droite.substr(10,1))-1],90*s+72,90*e+36,18,18),"pics_baiss"===salle.gauche.substr(0,10)&&map[e][s-1].is_salle&&map[e][s-1].droite===salle.gauche&&ctx.drawImage(imgs_pics_baisses[parseInt(salle.gauche.substr(10,1))-1],90*s+0,90*e+36,18,18)}}function activeInterrupteur(e){if(1==e&&0==orientationsInterrupteurs[0]?imgs_game[4]=img_interrupteur_rouge_active:1==e&&1==orientationsInterrupteurs[0]?imgs_game[4]=img_interrupteur_rouge:2==e&&0==orientationsInterrupteurs[1]?imgs_game[5]=img_interrupteur_bleu_active:2==e&&1==orientationsInterrupteurs[1]?imgs_game[5]=img_interrupteur_bleu:3==e&&0==orientationsInterrupteurs[2]?imgs_game[6]=img_interrupteur_vert_active:3==e&&1==orientationsInterrupteurs[2]?imgs_game[6]=img_interrupteur_vert:4==e&&0==orientationsInterrupteurs[3]?imgs_game[7]=img_interrupteur_jaune_active:4==e&&1==orientationsInterrupteurs[3]&&(imgs_game[7]=img_interrupteur_jaune),orientationsInterrupteurs[e-1]=1-orientationsInterrupteurs[e-1],e>=1&&e<=4)for(let s=0;s<64;s++)for(let a=0;a<100;a++)tile_nb=map_game[s][a],tile_nb==20+e?map_game[s][a]+=10:tile_nb==30+e&&(map_game[s][a]-=10)}function goToGame(){time_start=(new Date).getTime(),0==mode_cle&&(imgs_game[4]=img_interrupteur_rouge,imgs_game[5]=img_interrupteur_bleu,imgs_game[6]=img_interrupteur_vert,imgs_game[7]=img_interrupteur_jaune),xPerso=900*vi.j+320,yPerso=720*vi.i+400;for(let e=0;e<8;e++)for(let s=0;s<10;s++)for(let s=0;s<8;s++)map_game[8*e+s]=[],map_game[8*e+s]=0==s||7==s?[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]:[1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1];for(let e=0;e<8;e++)for(let s=0;s<10;s++){let a=map[e][s];a.is_salle&&("ouvert"===a.droite&&s<9&&map[e][s+1].is_salle&&"ouvert"===map[e][s+1].gauche&&(y_ouv_droite=1+Math.floor(6*Math.random()),map_game[8*e+y_ouv_droite][10*s+9]=0,10*s+10<100&&(map_game[8*e+y_ouv_droite][10*s+10]=0)),"ouvert"===a.bas&&e<7&&map[e+1][s].is_salle&&"ouvert"===map[e+1][s].haut&&(x_ouv_bas=1+Math.floor(8*Math.random()),map_game[8*e+7][10*s+x_ouv_bas]=0,8*e+8<64&&(map_game[8*e+8][10*s+x_ouv_bas]=0)),"door"===a.droite.substr(0,4)&&(y_ouv_droite=1+Math.floor(6*Math.random()),map_game[8*e+y_ouv_droite][10*s+9]=10+parseInt(a.droite.substr(4,1)),map_game[8*e+y_ouv_droite][10*s+10]=10+parseInt(a.droite.substr(4,1))),"door"===a.bas.substr(0,4)&&(x_ouv_bas=1+Math.floor(8*Math.random()),map_game[8*e+7][10*s+x_ouv_bas]=10+parseInt(a.bas.substr(4,1)),map_game[8*e+8][10*s+x_ouv_bas]=10+parseInt(a.bas.substr(4,1))),"pics_leves"===a.droite.substr(0,10)&&(y_ouv_droite=1+Math.floor(6*Math.random()),map_game[8*e+y_ouv_droite][10*s+9]=20+parseInt(a.droite.substr(10,1)),map_game[8*e+y_ouv_droite][10*s+10]=20+parseInt(a.droite.substr(10,1))),"pics_leves"===a.bas.substr(0,10)&&(x_ouv_bas=1+Math.floor(8*Math.random()),map_game[8*e+7][10*s+x_ouv_bas]=20+parseInt(a.bas.substr(10,1)),map_game[8*e+8][10*s+x_ouv_bas]=20+parseInt(a.bas.substr(10,1))),"pics_baiss"===a.droite.substr(0,10)&&(y_ouv_droite=1+Math.floor(6*Math.random()),map_game[8*e+y_ouv_droite][10*s+9]=30+parseInt(a.droite.substr(10,1)),map_game[8*e+y_ouv_droite][10*s+10]=30+parseInt(a.droite.substr(10,1))),"pics_baiss"===a.bas.substr(0,10)&&(x_ouv_bas=1+Math.floor(8*Math.random()),map_game[8*e+7][10*s+x_ouv_bas]=30+parseInt(a.bas.substr(10,1)),map_game[8*e+8][10*s+x_ouv_bas]=30+parseInt(a.bas.substr(10,1))),a.contains_key>0&&(x_cle=2+Math.floor(6*Math.random()),y_cle=2+Math.floor(4*Math.random()),map_game[8*e+y_cle][10*s+x_cle]=3+a.contains_key))}map_game[8*vi.i+4][10*vi.j+3]=2,map_game[8*vf.i+4][10*vf.j+3]=3;for(let e=0;e<8;e++)for(let s=0;s<10;s++){let a=map[e][s],i=[];if(a.is_salle){if(vi.i==e&&vi.j==s?i[i.length]={x:3,y:4}:vf.i==e&&vf.j==s&&(i[i.length]={x:3,y:4}),a.contains_key)for(let a=1;a<7;a++)for(let _=1;_<9;_++)map_game[8*e+a][10*s+_]>=4&&map_game[8*e+a][10*s+_]<=7&&(i[i.length]={x:_,y:a});nb_blocs=4+Math.floor(14*Math.random());for(let a=1;a<7;a++)x=0,1!=map_game[8*e+a][10*s+x]&&(i[i.length]={x:x,y:a}),x=9,1!=map_game[8*e+a][10*s+x]&&(i[i.length]={x:x,y:a});for(let a=1;a<9;a++)y=0,1!=map_game[8*e+y][10*s+a]&&(i[i.length]={x:a,y:y}),y=7,1!=map_game[8*e+y][10*s+a]&&(i[i.length]={x:a,y:y});for(;nb_blocs>0;){for(x_bloc=1+Math.floor(8*Math.random()),y_bloc=1+Math.floor(6*Math.random());0!=map_game[8*e+y_bloc][10*s+x_bloc];)x_bloc=1+Math.floor(8*Math.random()),y_bloc=1+Math.floor(6*Math.random());map_game[8*e+y_bloc][10*s+x_bloc]=1,valider_bloc=!0;for(let a=0;a<i.length;a++)for(let _=a+1;_<i.length;_++)x_1=i[a].x,y_1=i[a].y,x_2=i[_].x,y_2=i[_].y,chemin_existe(e,s,x_1,y_1,x_2,y_2)||(valider_bloc=!1);valider_bloc?nb_blocs-=1:map_game[8*e+y_bloc][10*s+x_bloc]=0}}}}function chemin_existe(e,s,a,i,_,l){let t=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]];for(let a=0;a<8;a++)for(let i=0;i<10;i++)t[a][i]=map_game[8*e+a][10*s+i];for(positions_atteignables_actu=[a+"-"+i],positions_atteignables_prec=[];positions_atteignables_prec.length<positions_atteignables_actu.length;){positions_atteignables_prec=JSON.parse(JSON.stringify(positions_atteignables_actu));for(let e=0;e<positions_atteignables_prec.length;e++){let s=parseInt(positions_atteignables_prec[e].split("-")[0]),a=parseInt(positions_atteignables_prec[e].split("-")[1]);s<9&&1!=t[a][s+1]&&(new_pos_atteignable=s+1+"-"+a,-1==positions_atteignables_actu.indexOf(new_pos_atteignable)&&positions_atteignables_actu.push(new_pos_atteignable)),s>0&&1!=t[a][s-1]&&(new_pos_atteignable=s-1+"-"+a,-1==positions_atteignables_actu.indexOf(new_pos_atteignable)&&positions_atteignables_actu.push(new_pos_atteignable)),a<7&&1!=t[a+1][s]&&(new_pos_atteignable=s+"-"+(a+1),-1==positions_atteignables_actu.indexOf(new_pos_atteignable)&&positions_atteignables_actu.push(new_pos_atteignable)),a>0&&1!=t[a-1][s]&&(new_pos_atteignable=s+"-"+(a-1),-1==positions_atteignables_actu.indexOf(new_pos_atteignable)&&positions_atteignables_actu.push(new_pos_atteignable))}}let r=_+"-"+l;return positions_atteignables_actu.indexOf(r)>-1}function animateGame(){requestAnimationFrame(animateGame),ctx.clearRect(0,0,1200,720),salle_i=Math.floor(yPerso/720),salle_j=Math.floor(xPerso/900),map_exploree[salle_i][salle_j]=1;for(let e=0;e<8;e++)for(let s=0;s<10;s++)tile_nb=map_game[8*salle_i+e][10*salle_j+s],tile_nb>=2&&tile_nb<=14&&ctx.drawImage(imgs_game[0],90*s,90*e,90,90),1==mode_cle&&tile_nb>=4&&tile_nb<=7&&1==orientationsInterrupteurs[tile_nb-4]?ctx.globalAlpha=.2:1==mode_cle&&tile_nb>=11&&tile_nb<=14&&1==orientationsInterrupteurs[tile_nb-11]&&(ctx.globalAlpha=.2),ctx.drawImage(imgs_game[tile_nb],90*s,90*e,90,90),ctx.globalAlpha=1;xMove=0,yMove=0,motion.left&&(xMove-=1),motion.right&&(xMove+=1),motion.up&&(yMove-=1),motion.down&&(yMove+=1),normeMove=Math.sqrt(xMove*xMove+yMove*yMove),normeMove>0&&(xMove*=4/normeMove,yMove*=4/normeMove,anim+=1,0==xMove?yMove>0?direction=0:direction=3:0==yMove&&(xMove>0?direction=2:direction=1),tile_desti1=map_game[Math.floor((yPerso+16)/90)][Math.floor((xPerso+16+xMove)/90)],tile_desti2=map_game[Math.floor((yPerso+16)/90)][Math.floor((xPerso-16+xMove)/90)],tile_desti3=map_game[Math.floor((yPerso-16)/90)][Math.floor((xPerso+16+xMove)/90)],tile_desti4=map_game[Math.floor((yPerso-16)/90)][Math.floor((xPerso-16+xMove)/90)],(0==tile_desti1||tile_desti1>30||tile_desti1>=2&&tile_desti1<=7||1==mode_cle&&tile_desti1>=11&&tile_desti1<=14&&1==orientationsInterrupteurs[tile_desti1-11])&&(0==tile_desti2||tile_desti2>30||tile_desti2>=2&&tile_desti2<=7||1==mode_cle&&tile_desti2>=11&&tile_desti2<=14&&1==orientationsInterrupteurs[tile_desti2-11])&&(0==tile_desti3||tile_desti3>30||tile_desti3>=2&&tile_desti3<=7||1==mode_cle&&tile_desti3>=11&&tile_desti3<=14&&1==orientationsInterrupteurs[tile_desti3-11])&&(0==tile_desti4||tile_desti4>30||tile_desti4>=2&&tile_desti4<=7||1==mode_cle&&tile_desti4>=11&&tile_desti4<=14&&1==orientationsInterrupteurs[tile_desti4-11])&&(xPerso+=xMove),tile_desti1=map_game[Math.floor((yPerso+16+yMove)/90)][Math.floor((xPerso+16)/90)],tile_desti2=map_game[Math.floor((yPerso+16+yMove)/90)][Math.floor((xPerso-16)/90)],tile_desti3=map_game[Math.floor((yPerso-16+yMove)/90)][Math.floor((xPerso+16)/90)],tile_desti4=map_game[Math.floor((yPerso-16+yMove)/90)][Math.floor((xPerso-16)/90)],(0==tile_desti1||tile_desti1>30||tile_desti1>=2&&tile_desti1<=7||1==mode_cle&&tile_desti1>=11&&tile_desti1<=14&&1==orientationsInterrupteurs[tile_desti1-11])&&(0==tile_desti2||tile_desti2>30||tile_desti2>=2&&tile_desti2<=7||1==mode_cle&&tile_desti2>=11&&tile_desti2<=14&&1==orientationsInterrupteurs[tile_desti2-11])&&(0==tile_desti3||tile_desti3>30||tile_desti3>=2&&tile_desti3<=7||1==mode_cle&&tile_desti3>=11&&tile_desti3<=14&&1==orientationsInterrupteurs[tile_desti3-11])&&(0==tile_desti4||tile_desti4>30||tile_desti4>=2&&tile_desti4<=7||1==mode_cle&&tile_desti4>=11&&tile_desti4<=14&&1==orientationsInterrupteurs[tile_desti4-11])&&(yPerso+=yMove)),xy_actu=compute_xy(xPerso,yPerso),xy_actu.x==xy_prec.x&&xy_actu.y==xy_prec.y||(xy_prec.x=xy_actu.x,xy_prec.y=xy_actu.y,0==mode_cle&&map_game[xy_actu.y][xy_actu.x]>=4&&map_game[xy_actu.y][xy_actu.x]<=7?activeInterrupteur(map_game[xy_actu.y][xy_actu.x]-3):1==mode_cle&&map_game[xy_actu.y][xy_actu.x]>=4&&map_game[xy_actu.y][xy_actu.x]<=7&&(orientationsInterrupteurs[map_game[xy_actu.y][xy_actu.x]-4]=1),3==map_game[xy_actu.y][xy_actu.x]&&time_victory<0&&(time_victory=(new Date).getTime()-time_start)),ctx.drawImage(img_personnage,Math.floor(anim/8)%4*64,64*direction,64,64,xPerso%900-32,yPerso%720-32,64,64);for(let e=0;e<8;e++)for(let s=0;s<10;s++)if(salle=map[e][s],1==map_exploree[e][s]&&salle.is_salle){for(let a=0;a<5;a++)for(let i=0;i<5;i++)ctx.drawImage(img_floor,900+(90*s+18*i)/3,(90*e+18*a)/3,6,6);vi.i==e&&vi.j==s&&ctx.drawImage(img_entree,900+(90*s+18)/3,(90*e+18)/3,18,18),vf.i==e&&vf.j==s&&ctx.drawImage(img_sortie,900+(90*s+18)/3,(90*e+18)/3,18,18),ctx.drawImage(img_wall,900+(90*s+0)/3,(90*e+0)/3,6,6),ctx.drawImage(img_wall,900+(90*s+18)/3,(90*e+0)/3,6,6),ctx.drawImage(img_wall,900+(90*s+54)/3,(90*e+0)/3,6,6),ctx.drawImage(img_wall,900+(90*s+72)/3,(90*e+0)/3,6,6),ctx.drawImage(img_wall,900+(90*s+0)/3,(90*e+72)/3,6,6),ctx.drawImage(img_wall,900+(90*s+18)/3,(90*e+72)/3,6,6),ctx.drawImage(img_wall,900+(90*s+54)/3,(90*e+72)/3,6,6),ctx.drawImage(img_wall,900+(90*s+72)/3,(90*e+72)/3,6,6),ctx.drawImage(img_wall,900+(90*s+0)/3,(90*e+18)/3,6,6),ctx.drawImage(img_wall,900+(90*s+0)/3,(90*e+54)/3,6,6),ctx.drawImage(img_wall,900+(90*s+72)/3,(90*e+18)/3,6,6),ctx.drawImage(img_wall,900+(90*s+72)/3,(90*e+54)/3,6,6),1==salle.contains_key?1==mode_cle?ctx.drawImage(img_cle_rouge,900+(90*s+18)/3,(90*e+18)/3,18,18):ctx.drawImage(img_interrupteur_rouge,900+(90*s+18)/3,(90*e+18)/3,18,18):2==salle.contains_key?1==mode_cle?ctx.drawImage(img_cle_bleue,900+(90*s+18)/3,(90*e+18)/3,18,18):ctx.drawImage(img_interrupteur_bleu,900+(90*s+18)/3,(90*e+18)/3,18,18):3==salle.contains_key?1==mode_cle?ctx.drawImage(img_cle_verte,900+(90*s+18)/3,(90*e+18)/3,18,18):ctx.drawImage(img_interrupteur_vert,900+(90*s+18)/3,(90*e+18)/3,18,18):4==salle.contains_key&&(1==mode_cle?ctx.drawImage(img_cle_jaune,900+(90*s+18)/3,(90*e+18)/3,18,18):ctx.drawImage(img_interrupteur_jaune,900+(90*s+18)/3,(90*e+18)/3,18,18)),ouvert_haut="ouvert"===salle.haut&&e>0&&map[e-1][s].is_salle&&"ouvert"===map[e-1][s].bas,ouvert_haut||ctx.drawImage(img_wall,900+(90*s+36)/3,(90*e+0)/3,6,6),ouvert_bas="ouvert"===salle.bas&&e<7&&map[e+1][s].is_salle&&"ouvert"===map[e+1][s].haut,ouvert_bas||ctx.drawImage(img_wall,900+(90*s+36)/3,(90*e+72)/3,6,6),ouvert_gauche="ouvert"===salle.gauche&&s>0&&map[e][s-1].is_salle&&"ouvert"===map[e][s-1].droite,ouvert_gauche||ctx.drawImage(img_wall,900+(90*s+0)/3,(90*e+36)/3,6,6),ouvert_droite="ouvert"===salle.droite&&s<9&&map[e][s+1].is_salle&&"ouvert"===map[e][s+1].gauche,ouvert_droite||ctx.drawImage(img_wall,900+(90*s+72)/3,(90*e+36)/3,6,6),"door"===salle.haut.substr(0,4)&&map[e-1][s].is_salle&&map[e-1][s].bas===salle.haut&&ctx.drawImage(imgs_portes[parseInt(salle.haut.substr(4,1))-1],900+(90*s+36)/3,(90*e+0)/3,6,6),"door"===salle.bas.substr(0,4)&&map[e+1][s].is_salle&&map[e+1][s].haut===salle.bas&&ctx.drawImage(imgs_portes[parseInt(salle.bas.substr(4,1))-1],900+(90*s+36)/3,(90*e+72)/3,6,6),"door"===salle.droite.substr(0,4)&&map[e][s+1].is_salle&&map[e][s+1].gauche===salle.droite&&ctx.drawImage(imgs_portes[parseInt(salle.droite.substr(4,1))-1],900+(90*s+72)/3,(90*e+36)/3,6,6),"door"===salle.gauche.substr(0,4)&&map[e][s-1].is_salle&&map[e][s-1].droite===salle.gauche&&ctx.drawImage(imgs_portes[parseInt(salle.gauche.substr(4,1))-1],900+(90*s+0)/3,(90*e+36)/3,6,6),"pics_leves"===salle.haut.substr(0,10)&&map[e-1][s].is_salle&&map[e-1][s].bas===salle.haut&&(0==orientationsInterrupteurs[salle.haut.substr(10,1)-1]?ctx.drawImage(imgs_pics_leves[parseInt(salle.haut.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+0)/3,6,6):ctx.drawImage(imgs_pics_baisses[parseInt(salle.haut.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+0)/3,6,6)),"pics_leves"===salle.bas.substr(0,10)&&map[e+1][s].is_salle&&map[e+1][s].haut===salle.bas&&(0==orientationsInterrupteurs[salle.bas.substr(10,1)-1]?ctx.drawImage(imgs_pics_leves[parseInt(salle.bas.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+72)/3,6,6):ctx.drawImage(imgs_pics_baisses[parseInt(salle.bas.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+72)/3,6,6)),"pics_leves"===salle.droite.substr(0,10)&&map[e][s+1].is_salle&&map[e][s+1].gauche===salle.droite&&(0==orientationsInterrupteurs[salle.droite.substr(10,1)-1]?ctx.drawImage(imgs_pics_leves[parseInt(salle.droite.substr(10,1))-1],0,0,30,30,900+(90*s+72)/3,(90*e+36)/3,6,6):ctx.drawImage(imgs_pics_baisses[parseInt(salle.droite.substr(10,1))-1],0,0,30,30,900+(90*s+72)/3,(90*e+36)/3,6,6)),"pics_leves"===salle.gauche.substr(0,10)&&map[e][s-1].is_salle&&map[e][s-1].droite===salle.gauche&&(0==orientationsInterrupteurs[salle.gauche.substr(10,1)-1]?ctx.drawImage(imgs_pics_leves[parseInt(salle.gauche.substr(10,1))-1],0,0,30,30,900+(90*s+0)/3,(90*e+36)/3,6,6):ctx.drawImage(imgs_pics_baisses[parseInt(salle.gauche.substr(10,1))-1],0,0,30,30,900+(90*s+0)/3,(90*e+36)/3,6,6)),"pics_baiss"===salle.haut.substr(0,10)&&map[e-1][s].is_salle&&map[e-1][s].bas===salle.haut&&(0==orientationsInterrupteurs[salle.haut.substr(10,1)-1]?ctx.drawImage(imgs_pics_baisses[parseInt(salle.haut.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+0)/3,6,6):ctx.drawImage(imgs_pics_leves[parseInt(salle.haut.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+0)/3,6,6)),"pics_baiss"===salle.bas.substr(0,10)&&map[e+1][s].is_salle&&map[e+1][s].haut===salle.bas&&(0==orientationsInterrupteurs[salle.bas.substr(10,1)-1]?ctx.drawImage(imgs_pics_baisses[parseInt(salle.bas.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+72)/3,6,6):ctx.drawImage(imgs_pics_leves[parseInt(salle.bas.substr(10,1))-1],0,0,30,30,900+(90*s+36)/3,(90*e+72)/3,6,6)),"pics_baiss"===salle.droite.substr(0,10)&&map[e][s+1].is_salle&&map[e][s+1].gauche===salle.droite&&(0==orientationsInterrupteurs[salle.droite.substr(10,1)-1]?ctx.drawImage(imgs_pics_baisses[parseInt(salle.droite.substr(10,1))-1],0,0,30,30,900+(90*s+72)/3,(90*e+36)/3,6,6):ctx.drawImage(imgs_pics_leves[parseInt(salle.droite.substr(10,1))-1],0,0,30,30,900+(90*s+72)/3,(90*e+36)/3,6,6)),"pics_baiss"===salle.gauche.substr(0,10)&&map[e][s-1].is_salle&&map[e][s-1].droite===salle.gauche&&(0==orientationsInterrupteurs[salle.gauche.substr(10,1)-1]?ctx.drawImage(imgs_pics_baisses[parseInt(salle.gauche.substr(10,1))-1],0,0,30,30,900+(90*s+0)/3,(90*e+36)/3,6,6):ctx.drawImage(imgs_pics_leves[parseInt(salle.gauche.substr(10,1))-1],0,0,30,30,900+(90*s+0)/3,(90*e+36)/3,6,6))}time_victory>0&&(ctx.fillStyle="#ffffff",ctx.strokeText("Victoire en "+Math.round(time_victory/1e3)+" secondes !",400,40),ctx.fillText("Victoire en "+Math.round(time_victory/1e3)+" secondes !",400,40)),ctx.drawImage(img_tete_personnage,900+30*salle_j+15-9,30*salle_i+15-7)}function ajout_salle(e,s){map[e][s].is_salle=!0,map[e][s].haut="ouvert",map[e][s].bas="ouvert",map[e][s].droite="ouvert",map[e][s].gauche="ouvert",e<7&&(map[e+1][s].haut="ouvert"),e>0&&(map[e-1][s].bas="ouvert"),s<9&&(map[e][s+1].gauche="ouvert"),s>0&&(map[e][s-1].droite="ouvert")}function retrait_salle(e,s){map[e][s].is_salle=!1,map[e][s].haut="ouvert",map[e][s].bas="ouvert",map[e][s].droite="ouvert",map[e][s].gauche="ouvert",e<7&&(map[e+1][s].haut="ouvert"),e>0&&(map[e-1][s].bas="ouvert"),s<9&&(map[e][s+1].gauche="ouvert"),s>0&&(map[e][s-1].droite="ouvert"),vi.i==e&&vi.j==s&&(vi={i:-1,j:-1}),vf.i==e&&vf.j==s&&(vf={i:-1,j:-1})}function ajout_cle(e,s){map[e][s].contains_key=1+map[e][s].contains_key%4}function retrait_cle(e,s){map[e][s].contains_key=0}function export_donjon(){dj_caml="open Graph.Pack.Graph;;\n\n",dj_caml+="let dj = Graph.Pack.Graph.create();;\n\n",nb_salles=0;for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s].is_salle&&(nb_salles+=1,map[e][s].num=nb_salles,dj_caml+="let v_"+nb_salles+" = V.create "+nb_salles+";;\n",dj_caml+="add_vertex dj v_"+nb_salles+";;\n");dj_caml+="\n";for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s].is_salle&&(idx_salle_1=map[e][s].num,idx_salle_2=0,"ouvert"===map[e][s].haut&&e>0&&map[e-1][s].is_salle&&"ouvert"===map[e-1][s].bas&&(idx_salle_2=map[e-1][s].num,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"),"ouvert"===map[e][s].haut&&e<7&&map[e+1][s].is_salle&&"ouvert"===map[e+1][s].haut&&(idx_salle_2=map[e+1][s].num,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"),"ouvert"===map[e][s].droite&&s<9&&map[e][s+1].is_salle&&"ouvert"===map[e][s+1].gauche&&(idx_salle_2=map[e][s+1].num,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"),"ouvert"===map[e][s].gauche&&s>0&&map[e][s-1].is_salle&&"ouvert"===map[e][s-1].droite&&(idx_salle_2=map[e][s-1].num,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"));download("exemple_donjon_"+nb_salles+".ml",dj_caml)}function export_donjon_reimportable_old_to_delete(){dj_caml="open Graph.Pack.Graph;;\n\n",dj_caml+="let dj = Graph.Pack.Graph.create();;\n\n",nb_salles=0;for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s].is_salle&&(nb_salles+=1,idx_salle_1=""+e+s,dj_caml+="let v_"+idx_salle_1+" = V.create "+idx_salle_1+";;\n",dj_caml+="Mark.set v_"+idx_salle_1+" "+map[e][s].contains_key+";;\n",dj_caml+="add_vertex dj v_"+idx_salle_1+";;\n");dj_caml+="\n";for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s].is_salle&&(idx_salle_1=""+e+s,idx_salle_2=0,"ouvert"===map[e][s].haut&&e>0&&map[e-1][s].is_salle&&"ouvert"===map[e-1][s].bas?(idx_salle_2=""+(e-1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):"door"===map[e][s].haut.substr(0,4)&&e>0&&map[e-1][s].is_salle&&map[e-1][s].bas===map[e][s].haut&&(idx_salle_2=""+(e-1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"),"ouvert"===map[e][s].bas&&e<7&&map[e+1][s].is_salle&&"ouvert"===map[e+1][s].haut?(idx_salle_2=""+(e+1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):"door"===map[e][s].bas.substr(0,4)&&e<5&&map[e+1][s].is_salle&&map[e+1][s].haut===map[e][s].bas&&(idx_salle_2=""+(e+1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"),"ouvert"===map[e][s].droite&&s<9&&map[e][s+1].is_salle&&"ouvert"===map[e][s+1].gauche?(idx_salle_2=""+e+(s+1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):"door"===map[e][s].droite.substr(0,4)&&s<9&&map[e][s+1].is_salle&&map[e][s+1].gauche===map[e][s].droite&&(idx_salle_2=""+e+(s+1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"),"ouvert"===map[e][s].gauche&&s>0&&map[e][s-1].is_salle&&"ouvert"===map[e][s-1].droite?(idx_salle_2=""+e+(s-1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):"door"===map[e][s].gauche.substr(0,4)&&s>0&&map[e][s-1].is_salle&&map[e][s-1].droite===map[e][s].gauche&&(idx_salle_2=""+e+(s-1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"));download("exemple_donjon_"+nb_salles+".ml",dj_caml)}function export_donjon_reimportable(){dj_caml="open Graph.Pack.Graph;;\n\n",dj_caml+="let dj = Graph.Pack.Graph.create();;\n\n",nb_salles=0,keys=[];for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s].is_salle&&(nb_salles+=1,idx_salle_1=""+e+s,dj_caml+="let v_"+idx_salle_1+" = V.create "+idx_salle_1+";;\n",dj_caml+="add_vertex dj v_"+idx_salle_1+";;\n",map[e][s].contains_key>0&&(keys[keys.length]={i:e,j:s,n:map[e][s].contains_key}));dj_caml+="\n";for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s].is_salle&&(idx_salle_1=""+e+s,idx_salle_2=0,("ouvert"===map[e][s].haut||"pics_baiss"===map[e][s].haut.substr(0,10))&&e>0&&map[e-1][s].is_salle&&("ouvert"===map[e-1][s].bas||"pics_baiss"===map[e-1][s].bas.substr(0,10))?(idx_salle_2=""+(e-1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):("door"===map[e][s].haut.substr(0,4)||"pics_leves"===map[e][s].haut.substr(0,10))&&e>0&&map[e-1][s].is_salle&&map[e-1][s].bas===map[e][s].haut&&(idx_salle_2=""+(e-1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"),("ouvert"===map[e][s].bas||"pics_baiss"===map[e][s].bas.substr(0,10))&&e<7&&map[e+1][s].is_salle&&("ouvert"===map[e+1][s].haut||"pics_baiss"===map[e+1][s].haut.substr(0,10))?(idx_salle_2=""+(e+1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):("door"===map[e][s].bas.substr(0,4)||"pics_leves"===map[e][s].bas.substr(0,10))&&e<5&&map[e+1][s].is_salle&&map[e+1][s].haut===map[e][s].bas&&(idx_salle_2=""+(e+1)+s,dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"),("ouvert"===map[e][s].droite||"pics_baiss"===map[e][s].droite.substr(0,10))&&s<9&&map[e][s+1].is_salle&&("ouvert"===map[e][s+1].gauche||"pics_baiss"===map[e][s+1].gauche.substr(0,10))?(idx_salle_2=""+e+(s+1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):("door"===map[e][s].droite.substr(0,4)||"pics_leves"===map[e][s].droite.substr(0,10))&&s<9&&map[e][s+1].is_salle&&map[e][s+1].gauche===map[e][s].droite&&(idx_salle_2=""+e+(s+1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"),("ouvert"===map[e][s].gauche||"pics_baiss"===map[e][s].gauche.substr(0,10))&&s>0&&map[e][s-1].is_salle&&("ouvert"===map[e][s-1].droite||"pics_baiss"===map[e][s-1].droite.substr(0,10))?(idx_salle_2=""+e+(s-1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n",dj_caml+="add_edge_e dj e_"+idx_salle_1+"_"+idx_salle_2+";;\n"):("door"===map[e][s].gauche.substr(0,4)||"pics_leves"===map[e][s].gauche.substr(0,10))&&s>0&&map[e][s-1].is_salle&&map[e][s-1].droite===map[e][s].gauche&&(idx_salle_2=""+e+(s-1),dj_caml+="let e_"+idx_salle_1+"_"+idx_salle_2+" = E.create v_"+idx_salle_1+" 1 v_"+idx_salle_2+";;\n"));if(1==mode_cle){dj_caml+="\nlet doors = [ ";for(let e=0;e<keys.length;e++){e>0&&(dj_caml+="; "),dj_caml+="(v_"+keys[e].i+keys[e].j+", [",list_edges=[];for(let s=0;s<8;s++)for(let a=0;a<10;a++)map[s][a].is_salle&&(idx_salle_1=""+s+a,idx_salle_2=0,"door"===map[s][a].haut.substr(0,4)&&parseInt(map[s][a].haut.substr(4,1))===keys[e].n&&s>0&&map[s-1][a].is_salle&&map[s-1][a].bas===map[s][a].haut&&(idx_salle_2=""+(s-1)+a,list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2),"door"===map[s][a].bas.substr(0,4)&&parseInt(map[s][a].bas.substr(4,1))===keys[e].n&&s<5&&map[s+1][a].is_salle&&map[s+1][a].haut===map[s][a].bas&&(idx_salle_2=""+(s+1)+a,list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2),"door"===map[s][a].droite.substr(0,4)&&parseInt(map[s][a].droite.substr(4,1))===keys[e].n&&a<9&&map[s][a+1].is_salle&&map[s][a+1].gauche===map[s][a].droite&&(idx_salle_2=""+s+(a+1),list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2),"door"===map[s][a].gauche.substr(0,4)&&parseInt(map[s][a].gauche.substr(4,1))===keys[e].n&&a>0&&map[s][a-1].is_salle&&map[s][a-1].droite===map[s][a].gauche&&(idx_salle_2=""+s+(a-1),list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2));for(let e=0;e<list_edges.length;e++)e>0&&(dj_caml+="; "),dj_caml+=list_edges[e];dj_caml+="])"}dj_caml+=" ]"}else if(0==mode_cle){dj_caml+="\nlet interrupteurs = [ ";for(let e=0;e<keys.length;e++){e>0&&(dj_caml+="; "),dj_caml+="(v_"+keys[e].i+keys[e].j+", [",list_edges=[];for(let s=0;s<8;s++)for(let a=0;a<10;a++)map[s][a].is_salle&&(idx_salle_1=""+s+a,idx_salle_2=0,"pics"===map[s][a].haut.substr(0,4)&&parseInt(map[s][a].haut.substr(10,1))===keys[e].n&&s>0&&map[s-1][a].is_salle&&map[s-1][a].bas===map[s][a].haut&&(idx_salle_2=""+(s-1)+a,list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2),"pics"===map[s][a].bas.substr(0,4)&&parseInt(map[s][a].bas.substr(10,1))===keys[e].n&&s<5&&map[s+1][a].is_salle&&map[s+1][a].haut===map[s][a].bas&&(idx_salle_2=""+(s+1)+a,list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2),"pics"===map[s][a].droite.substr(0,4)&&parseInt(map[s][a].droite.substr(10,1))===keys[e].n&&a<9&&map[s][a+1].is_salle&&map[s][a+1].gauche===map[s][a].droite&&(idx_salle_2=""+s+(a+1),list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2),"pics"===map[s][a].gauche.substr(0,4)&&parseInt(map[s][a].gauche.substr(10,1))===keys[e].n&&a>0&&map[s][a-1].is_salle&&map[s][a-1].droite===map[s][a].gauche&&(idx_salle_2=""+s+(a-1),list_edges[list_edges.length]="e_"+idx_salle_1+"_"+idx_salle_2));for(let e=0;e<list_edges.length;e++)e>0&&(dj_caml+="; "),dj_caml+=list_edges[e];dj_caml+="])"}dj_caml+=" ]"}vi.i>-1&&vi.j>-1&&(dj_caml+="\n\nlet vi = v_"+vi.i+vi.j+";;"),vf.i>-1&&vf.j>-1&&(dj_caml+="\n\nlet vf = v_"+vf.i+vf.j+";;"),download("exemple_donjon_"+nb_salles+".ml",dj_caml)}function import_donjon(e){for(let e=0;e<8;e++)for(let s=0;s<10;s++)map[e][s]={is_salle:!1,haut:"ferme",bas:"ferme",droite:"ferme",gauche:"ferme",contains_key:0};for(cle_idx=1,liste_ouvertures=[],mode_cle=1==e.split("interrupteurs").length,lignes=e.split("\n"),l=0;l<lignes.length;l++)lignes[l].length>0&&(vertex=lignes[l].split("let v_"),2==vertex.length&&(i_vertex=parseInt(vertex[1][0]),j_vertex=parseInt(vertex[1][1]),map[i_vertex][j_vertex].is_salle=!0),key=lignes[l].split("Mark.set v_"),2==key.length&&(i_vertex=parseInt(key[1][0]),j_vertex=parseInt(key[1][1])),edge=lignes[l].split("add_edge_e dj e_"),2==edge.length&&(idx_vertices=edge[1].split("_"),i_1=idx_vertices[0][0],j_1=idx_vertices[0][1],i_2=idx_vertices[1][0],j_2=idx_vertices[1][1],i_1>=0&&i_1<=6&&i_2==i_1+1&&j_1>=0&&j_1<=9&&j_2==j_1&&(map[i_1][j_1].bas="ouvert",map[i_2][j_2].haut="ouvert"),i_1>=1&&i_1<=7&&i_2==i_1-1&&j_1>=0&&j_1<=9&&j_2==j_1&&(map[i_1][j_1].haut="ouvert",map[i_2][j_2].bas="ouvert"),i_1>=0&&i_1<=7&&i_2==i_1&&j_1>=1&&j_1<=9&&j_2==j_1-1&&(map[i_1][j_1].gauche="ouvert",map[i_2][j_2].droite="ouvert"),i_1>=0&&i_1<=7&&i_2==i_1&&j_1>=0&&j_1<=8&&j_2==j_1+1&&(map[i_1][j_1].droite="ouvert",map[i_2][j_2].gauche="ouvert")));for(l=0;l<lignes.length;l++)if(lignes[l].length>0){if(1==mode_cle){if(door=lignes[l].split("let doors = "),2==door.length)for(keys=door[1].split("v_"),key_nb=1;key_nb<keys.length;key_nb++){liste_ouv=keys[key_nb].split("[")[1].split("]")[0],idx_ouv=liste_ouvertures.indexOf(liste_ouv),-1==idx_ouv?(liste_ouvertures[liste_ouvertures.length]=liste_ouv,cle_idx=liste_ouvertures.length):cle_idx=1+idx_ouv,i_cle=keys[key_nb][0],j_cle=keys[key_nb][1],map[i_cle][j_cle].contains_key=cle_idx,doors_opened=keys[key_nb].split("e_");for(let e=1;e<doors_opened.length;e++)i_1=doors_opened[e][0],j_1=doors_opened[e][1],i_2=doors_opened[e][3],j_2=doors_opened[e][4],door_nb=cle_idx,i_1>=0&&i_1<=6&&i_2==i_1+1&&j_1>=0&&j_1<=9&&j_2==j_1&&(map[i_1][j_1].bas="door"+door_nb,map[i_2][j_2].haut="door"+door_nb),i_1>=1&&i_1<=7&&i_2==i_1-1&&j_1>=0&&j_1<=9&&j_2==j_1&&(map[i_1][j_1].haut="door"+door_nb,map[i_2][j_2].bas="door"+door_nb),i_1>=0&&i_1<=7&&i_2==i_1&&j_1>=1&&j_1<=9&&j_2==j_1-1&&(map[i_1][j_1].gauche="door"+door_nb,map[i_2][j_2].droite="door"+door_nb),i_1>=0&&i_1<=7&&i_2==i_1&&j_1>=0&&j_1<=8&&j_2==j_1+1&&(map[i_1][j_1].droite="door"+door_nb,map[i_2][j_2].gauche="door"+door_nb)}}else if(door=lignes[l].split("let interrupteurs = "),2==door.length)for(keys=door[1].split("v_"),key_nb=1;key_nb<keys.length;key_nb++){liste_ouv=keys[key_nb].split("[")[1].split("]")[0],idx_ouv=liste_ouvertures.indexOf(liste_ouv),-1==idx_ouv?(liste_ouvertures[liste_ouvertures.length]=liste_ouv,cle_idx=liste_ouvertures.length):cle_idx=1+idx_ouv,i_cle=keys[key_nb][0],j_cle=keys[key_nb][1],map[i_cle][j_cle].contains_key=cle_idx,doors_opened=keys[key_nb].split("e_");for(let e=1;e<doors_opened.length;e++)i_1=doors_opened[e][0],j_1=doors_opened[e][1],i_2=doors_opened[e][3],j_2=doors_opened[e][4],door_nb=cle_idx,i_1>=0&&i_1<=6&&i_2==i_1+1&&j_1>=0&&j_1<=9&&j_2==j_1&&("ferme"===map[i_1][j_1].bas||"pics_leves"===map[i_1][j_1].bas.substr(0,10)?(map[i_1][j_1].bas="pics_leves"+door_nb,map[i_2][j_2].haut="pics_leves"+door_nb):(map[i_1][j_1].bas="pics_baiss"+door_nb,map[i_2][j_2].haut="pics_baiss"+door_nb)),i_1>=1&&i_1<=7&&i_2==i_1-1&&j_1>=0&&j_1<=9&&j_2==j_1&&("ferme"===map[i_1][j_1].haut||"pics_leves"===map[i_1][j_1].haut.substr(0,10)?(map[i_1][j_1].haut="pics_leves"+door_nb,map[i_2][j_2].bas="pics_leves"+door_nb):(map[i_1][j_1].haut="pics_baiss"+door_nb,map[i_2][j_2].bas="pics_baiss"+door_nb)),i_1>=0&&i_1<=7&&i_2==i_1&&j_1>=1&&j_1<=9&&j_2==j_1-1&&("ferme"===map[i_1][j_1].gauche||"pics_leves"===map[i_1][j_1].gauche.substr(0,10)?(map[i_1][j_1].gauche="pics_leves"+door_nb,map[i_2][j_2].droite="pics_leves"+door_nb):(map[i_1][j_1].gauche="pics_baiss"+door_nb,map[i_2][j_2].droite="pics_baiss"+door_nb)),i_1>=0&&i_1<=7&&i_2==i_1&&j_1>=0&&j_1<=8&&j_2==j_1+1&&("ferme"===map[i_1][j_1].droite||"pics_leves"===map[i_1][j_1].droite.substr(0,10)?(map[i_1][j_1].droite="pics_leves"+door_nb,map[i_2][j_2].gauche="pics_leves"+door_nb):(map[i_1][j_1].droite="pics_baiss"+door_nb,map[i_2][j_2].gauche="pics_baiss"+door_nb))}entree=lignes[l].split("let vi = v_"),2==entree.length&&(vi.i=entree[1][0],vi.j=entree[1][1]),sortie=lignes[l].split("let vf = v_"),2==sortie.length&&(vf.i=sortie[1][0],vf.j=sortie[1][1])}}function download(e,s){var a=document.createElement("a");a.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(s)),a.setAttribute("download",e),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)}donjonImporter.addEventListener("change",handleAnnotationsSelect,!1),direction=0,anim=0,motion={left:!1,right:!1,down:!1,up:!1},this.onKeyDown=function(e){37!=e.keyCode&&81!=e.keyCode||(motion.left=!0),39!=e.keyCode&&68!=e.keyCode||(motion.right=!0),38!=e.keyCode&&90!=e.keyCode||(motion.up=!0),40!=e.keyCode&&83!=e.keyCode||(motion.down=!0)},this.onKeyUp=function(e){37!=e.keyCode&&81!=e.keyCode||(motion.left=!1),39!=e.keyCode&&68!=e.keyCode||(motion.right=!1),38!=e.keyCode&&90!=e.keyCode||(motion.up=!1),40!=e.keyCode&&83!=e.keyCode||(motion.down=!1)},document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),mode=1,mode_cle=1,continue_edition=1,xPerso=4,yPerso=3,animate();
